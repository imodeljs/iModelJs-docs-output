<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Spatial Queries - iModel.js</title>
    <meta name="og:title" content="Spatial Queries - iModel.js">
    <meta name="twitter:title" content="Spatial Queries - iModel.js">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" type="text/css" href="https://imodeljs.github.io/iModelJs-docs-output//styles/bundle.css">

    <!-- bootstrap -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>

    <!-- fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet"> 
    
    <link rel="stylesheet" type="text/css" href="https://imodeljs.github.io/iModelJs-docs-output//styles/devRegistration.css"> 
    
    <link rel="stylesheet" type="text/css" href="https://imodeljs.github.io/iModelJs-docs-output//styles/landingPage.css">  
        <link rel='shortcut icon' type='image/x-icon' href='https://imodeljs.github.io/iModelJs-docs-output//landing-page/assets/imodeljs_16.png' /> 
        <meta property="og:description" content="Create Immersive Connections with your Infrastructure Digital Twin."><meta property="og:url" content="imodeljs.org"><meta name="twitter:card" content="summary_large_image">
        <meta property="og:image" content="https://imodeljs.github.io/iModelJs-docs-output//landing-page/assets/twitter-share.png">
        <meta />
</head>

<body data-site-root=https://imodeljs.github.io/iModelJs-docs-output// class='layout-index '>
    <span id="contentLoader">
        <p>Woah! This page has a great deal of content... Give us a second to load it.</p>
    </span>
    <span id="contentLoaderBackground"></span>
    <div id="flex-wrapper">



        <header id="main-header">
            <div class='nav-header-container'>
                <nav class="navbar nav-main-header navbar-expand-md fixed-top navbar-light pb-0">
                    <a href="https://imodeljs.github.io/iModelJs-docs-output//" class="navbar-brand">
                            <img id="site-logo" class="site-logo" src="https://imodeljs.github.io/iModelJs-docs-output//landing-page/assets/imodeljs-logo.svg" /> 
                            <img id="site-logo-small" class="site-logo-small" src="https://imodeljs.github.io/iModelJs-docs-output//landing-page/assets/imodeljs-icon.svg" style="display:none;"/> 
                    </a>
                    <button class="navbar-toggler no-user-select mr-auto" type="button" data-toggle="collapse" data-target="#navbar5">
                        <span class="navbar-toggler-header"></span>
                    </button>
                    <ul class="navbar-nav ml-auto pr-0 nav-search">
                        <span class='search-bar'>
                          <li>
                            <div id='search-container'>
                            </div>
                          </li>
                          <script>
                            (function() {
                              var cx = '018053174497532353467:v_gnrjjlqwc';
                              var gcse = document.createElement('script');
                              gcse.type = 'text/javascript';
                              gcse.async = true;
                              gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
                              var s = document.getElementsByTagName('script')[0];
                              s.parentNode.insertBefore(gcse, s);
                            })();
                          </script>
                          <gcse:searchresults-only gname="sitesearch" resultSetSize="7"></gcse:search>
                        </span>
                    </ul>
                    <div class="navbar-collapse collapse justify-content-stretch" id="navbar5">
                        <ul class="navbar-nav mb-0" id="doc-site-tabs">
                                <li class="nav-item "><a class="nav-link" href="https://imodeljs.github.io/iModelJs-docs-output//getting-started">Getting Started</a></li><li class="nav-item "><a class="nav-link" href="https://imodeljs.github.io/iModelJs-docs-output//bis">BIS</a></li><li class="nav-item active"><a class="nav-link" href="https://imodeljs.github.io/iModelJs-docs-output//learning">Learning</a></li><li class="nav-item "><a class="nav-link" href="https://imodeljs.github.io/iModelJs-docs-output//reference">API Reference</a></li><li class="nav-item change-history-tab "><a class="nav-link" href="https://imodeljs.github.io/iModelJs-docs-output//changehistory">v1.6.0</a></li>
                        </ul>
                    </div>
                </nav>
            </div>
        </header>
<div id='main-wrapper'>
    <nav id='sidebar'>
        <div id='table-of-contents' class="custom-scrollbar">
            <div id="dismiss">
                <i id="dismiss-arrow" class="icon icon-chevron-left no-user-select"></i>
            </div>
            <hr id="dismiss-hr" class='sm-only'>
            <ul id='main-navigation-list'>
                <html><head></head><body><h3 id="the imodel.js library"><a href="https://imodeljs.github.io/iModelJs-docs-output//learning/" class="table-of-contents-link">The iModel.js Library</a></h3>
    <ul>
    <li><a href="https://imodeljs.github.io/iModelJs-docs-output//learning/frontend/" class="table-of-contents-link">Frontend</a></li>
    <li><a href="https://imodeljs.github.io/iModelJs-docs-output//learning/backend/" class="table-of-contents-link">Backend</a></li>
    <li><a href="https://imodeljs.github.io/iModelJs-docs-output//learning/common/" class="table-of-contents-link">Common</a></li>
    <li><a href="https://imodeljs.github.io/iModelJs-docs-output//learning/geometry/" class="table-of-contents-link">Geometry</a></li>
    <li><a href="https://imodeljs.github.io/iModelJs-docs-output//learning/presentation/" class="table-of-contents-link">Presentation</a></li>
    <li><a href="https://imodeljs.github.io/iModelJs-docs-output//learning/ui/" class="table-of-contents-link">UI</a></li>
    </ul>
    <hr>
    <p>&#xA0;</p>
    <h3 id="helpful links">Helpful links</h3>
    <ul>
    <li><a href="https://imodeljs.github.io/iModelJs-docs-output//./learning/ecsql" class="table-of-contents-link">ECSQL</a></li>
    <li><a href="https://imodeljs.github.io/iModelJs-docs-output//learning/imodelhub/" class="table-of-contents-link">iModelHub</a></li>
    <li><a href="https://imodeljs.github.io/iModelJs-docs-output//./learning/wireformat" class="table-of-contents-link">Wire Format</a></li>
    <li><a href="https://imodeljs.github.io/iModelJs-docs-output//./learning/faq" class="table-of-contents-link">Frequently Asked Questions</a></li>
    <li><a href="https://imodeljs.github.io/iModelJs-docs-output//learning/guidelines/" class="table-of-contents-link">Guidelines and Tips</a></li>
    <li><a href="https://imodeljs.github.io/iModelJs-docs-output//./learning/glossary" class="table-of-contents-link">Glossary</a></li>
    </ul>
    </body></html>
            </ul>
        </div>
    </nav>    <div class='documentation-main'>
        <article id="main" class="main-content">
            <button type="button" id="sidebarCollapse" class="no-user-select"> <i class="bread-crumb-label bread-crumb-expand-leftnav icon icon-chevron-right no-user-select" id="expand-leftnav"></i></button><div class='bread-crumb-label'><a href="https://imodeljs.github.io/iModelJs-docs-output//learning/">Learning</a> > <a href="https://imodeljs.github.io/iModelJs-docs-output//learning/ecsqltutorial/">ecsqltutorial</a> > SpatialQueries</div>
            <div class="edit-link"><a href="https://github.com/imodeljs/imodeljs/tree/master/docs/learning/ECSQLTutorial/SpatialQueries.md">Edit this page</a></div>
            <h1 id="spatial queries">Spatial Queries</h1>
<p>Every instance of the <a href='https://imodeljs.github.io/iModelJs-docs-output//./bis/domains/biscore.ecschema/#spatialelement'>SpatialElement</a> ECClass in an iModel is spatially indexed. The spatial index allows fast look-ups by spatial criteria. Each row in the spatial index is conceptually a bounding cube, plus the ECInstanceId of an element that is enclosed by it.</p>
<p>The index is exposed to ECSQL via the ECClass <a href='https://imodeljs.github.io/iModelJs-docs-output//./bis/domains/biscore.ecschema/#spatialindex'>BisCore.SpatialIndex</a>. See <a href='https://imodeljs.github.io/iModelJs-docs-output//./learning/spatialqueries'>ECSQL Reference</a> for details.</p>
<blockquote>
<p><strong>Try it yourself</strong></p>
<p><em>Goal:</em> Return all <a href='https://imodeljs.github.io/iModelJs-docs-output//./bis/domains/biscore.ecschema/#spatialelement'>SpatialElement</a>s that are contained or overlap a cube defined by the minimum coordinate (0|0|0) and maximum coordinate (10|10|10).</p>
<p><em>ECSQL</em></p>
<pre class="no-line-numbers"><code class="language-sql">SELECT e.ECInstanceId, e.CodeValue FROM bis.SpatialElement e JOIN bis.SpatialIndex i ON e.ECInstanceId=i.ECInstanceId WHERE i.MinX&lt;=10 AND i.MinY&lt;=10 AND i.MinZ&lt;=10 AND i.MaxX&gt;=0 AND i.MaxY&gt;=0 AND i.MaxZ&gt;=0</code></pre>
<p><em>Result</em></p>
<table class="table table-responsive"><tbody><tr>
<th>ECInstanceId</th>
<th>CodeValue</th>
</tr>
<tr>
<td>0x1000000001d</td>
<td>Building A</td>
</tr>
<tr>
<td>0x10000000020</td>
<td>DEV-A-G-1</td>
</tr>
<tr>
<td>0x10000000022</td>
<td>DEV-A-G-2</td>
</tr>
<tr>
<td>0x10000000025</td>
<td>DEV-A-1-1</td>
</tr>
<tr>
<td>0x20000000002</td>
<td>DEV-A-G-4</td>
</tr>
<tr>
<td>0x1000000001f</td>
<td>A-G-1</td>
</tr>
<tr>
<td>0x10000000021</td>
<td>A-G-2</td>
</tr>
<tr>
<td>0x10000000024</td>
<td>A-1-1</td>
</tr>
<tr>
<td>0x1000000001e</td>
<td>A-G</td>
</tr>
<tr>
<td>0x10000000023</td>
<td>A-1</td>
</tr>
</tbody></table></blockquote>
<p>For more complex spatial criteria the <code>MATCH</code> keyword together with the special built-in spatial index matching function <code>iModel_spatial_overlap_aabb</code> is used. The MATCH clause acts like a sub-selection that generates a set of ECInstanceIds, which it gathers from the spatial index rows that match the specified criteria.
The function <code>iModel_spatial_overlap_aabb</code> selects all nodes that overlap a specified axis-aligned <a href='https://imodeljs.github.io/iModelJs-docs-output//./learning/geometrysqlfuncs/#imodel_bbox'>bounding box</a>.</p>
<p>See also other <a href='https://imodeljs.github.io/iModelJs-docs-output//./learning/geometrysqlfuncs'>ECSQL built-in geometry functions</a> which can be used along with spatial queries as additional WHERE criteria.</p>
<blockquote>
<p><strong>Try it yourself</strong>
The argument to the match function can only be passed via an ECSQL parameter. As the iModelConsole does not support parameter values, the following example cannot be tried out with the iModelConsole. You would have to put the sample code into your own playground.</p>
<p><em>Goal:</em> Return all <a href='https://imodeljs.github.io/iModelJs-docs-output//./bis/domains/biscore.ecschema/#spatialelement'>SpatialElement</a>s which overlap the <a href='https://imodeljs.github.io/iModelJs-docs-output//./learning/ecsqltutorial/mydomain.ecschema/#space'>Space</a> with id 0x1000000001f and which are in the <a href='https://imodeljs.github.io/iModelJs-docs-output//./bis/domains/biscore.ecschema/#category'>Category</a> with id 0x1000000000a.</p>
<p><em>ECSQL</em></p>
<pre class="no-line-numbers"><code class="language-sql">SELECT e.ECInstanceId, e.CodeValue FROM bis.SpatialElement e JOIN bis.SpatialIndex i ON e.ECInstanceId=i.ECInstanceId WHERE i.ECInstanceId MATCH iModel_spatial_overlap_aabb(?) AND e.Category.Id=0x1000000000a</code></pre>
<p><em>Sample code</em></p>
<pre class="no-line-numbers"><code class="language-typescript">const spaceElement: SpatialElement = iModelDb.elements.getElement(&quot;0x1000000001f&quot;) as SpatialElement;

iModelDb.withPreparedStatement(&quot;SELECT e.ECInstanceId, e.ECClassId, e.CodeValue FROM bis.SpatialElement e JOIN bis.SpatialIndex i ON e.ECInstanceId=i.ECInstanceId WHERE i.ECInstanceId MATCH iModel_spatial_overlap_aabb(?) AND e.Category.Id=0x1000000000a&quot;,
   (stmt: ECSqlStatement) =&gt; {
     stmt.bindRange3d(1, spaceElement.placement.calculateRange());
     while (stmt.step() === DbResult.BE_SQLITE_ROW) {
        const row: any = stmt.getRow();
        console.log(row);
     }
   });</code></pre>
<p><em>Result</em></p>
<pre class="no-line-numbers"><code class="language-typescript">{ id : &quot;0x1000000001e&quot;, className: &quot;MyDomain.Story&quot;, codeValue: &quot;A-G&quot; }
{ id : &quot;0x10000000023&quot;, className: &quot;MyDomain.Story&quot;, codeValue: &quot;A-1&quot; }</code></pre>
</blockquote>
<hr>
<p><a href='https://imodeljs.github.io/iModelJs-docs-output//./learning/ecsqltutorial/polymorphicqueries'><strong>&lt; Previous</strong></a> &#xA0; | &#xA0; <a href='https://imodeljs.github.io/iModelJs-docs-output//./learning/ecsqltutorial/metaqueries'><strong>Next &gt;</strong></a></p>

            <p class='last-updated'>Last Updated:
                <span class='date-updated'>10 October, 2019</span>
            </p>
            <div id="imodeljs-github-comments">
            </div>
            
            <script>
              $(document).ready(function () {
                function initializeComments(repo) {
                  var s = document.createElement('script');
                  s.src = "https://imodeljs.github.io/iModelJs-docs-output//scripts/utterances/client.js";
                  s.setAttribute('repo', repo);
                  s.setAttribute('issue-term', 'title');
                  s.setAttribute('crossorigin', 'anonymous');
                  s.setAttribute('theme', 'github-light');
                  s.async = true;
            
                  document.getElementById("imodeljs-github-comments").appendChild(s);
                }
            
                var shouldShow = ldclient.variation(featureFlags.GithubIssuesFeedback);
            
                // shouldShow is undefined when ldclient has not emitted 'ready'.
                if (shouldShow === undefined) {
                  ldclient.on('ready', function () {
                    var gitIssueFlag = ldclient.variation(featureFlags.GithubIssuesFeedback);
                    var gitRepo = ldclient.variation(featureFlags.GitRepo);
                    if (gitIssueFlag) {
                      initializeComments(gitRepo);
                    }
                  });
                }
                else if (shouldShow) {
                  var gitRepo = ldclient.variation(featureFlags.GitRepo);
                  initializeComments(gitRepo);
                }
              });
            </script>
            
            <script type="text/javascript">
            
            </script>        </article>
    </div>
    <div class="toc-overlay"></div>
    <div id='inner-table-of-contents'>
       <!-- 
 -->
    </div>
</div>

<!-- Footer -->
<footer class="page-footer font-small mdb-color pt-1 pb-3">
  <!-- Footer Links Container -->
  <div class="container text-center text-md-left">

    <!-- Grid row -->
    <div class="row d-flex align-items-center mt-2">

      <!-- Grid column -->
      <div class="col-md-7 col-lg-8 align-top d-none d-md-block">

        <a href="https://imodeljs.github.io/iModelJs-docs-output//" class="navbar-brand">
          <img id="site-logo" class="site-logo" style="zoom:75%;"
            src="https://imodeljs.github.io/iModelJs-docs-output//landing-page/assets/imodeljs-logo.svg" />
        </a>
        <small style="color: white; margin-right: 7px;"> powered by </small>
        <a href="https://www.bentley.com">
          <img href="https://www.bentley.com" id="sponsored-by-logo" class="sponsored-by-logo"
            style="zoom:75%; width: 162px; height: 37px;"
            src="https://imodeljs.github.io/iModelJs-docs-output//landing-page/assets/bentley.svg" />
        </a>
      </div>
      <!-- Grid column -->

      <!-- Grid column -->
      <div class="col-md-5 col-lg-4 ml-lg-0">

        <!-- Social buttons -->
        <div class="text-center text-md-right">
          <ul class="list-unstyled list-inline">
            <li class="list-inline-item">
              <a class="btn-floating btn-sm rgba-white-slight mx-1" href="https://twitter.com/imodeljs" target="_blank">
                <i class="fa fa-twitter"></i>
              </a>
            </li>
            </li>
            <li class="list-inline-item">
              <a class="btn-floating btn-sm rgba-white-slight mx-1" href="https://github.com/imodeljs" target="_blank">
                <i class="fa fa-github"></i>
              </a>
            </li>
            <li class="list-inline-item">
              <a class="btn-floating btn-sm rgba-white-slight mx-1" href="https://stackoverflow.com/tags/imodeljs"
                target="_blank">
                <i class="fa fa-stack-overflow"></i>
              </a>
            </li>
          </ul>
        </div>

      </div>
      <!-- Grid column -->

    </div>
    <!-- Grid row -->

  </div>
  <!-- Footer Links Container -->

</footer>
<!-- Footer -->

</div>
<a href="javascript:" id="return-to-top"><i class="icon icon-chevron-up"></i></a>
<script src="https://imodeljs.github.io/iModelJs-docs-output//scripts/bundle.js"></script>
</body>

</html>
<script src="https://imodeljs.github.io/iModelJs-docs-output//scripts/monaco-editor/min/vs/loader.js"></script>
<script src="https://imodeljs.github.io/iModelJs-docs-output//scripts/ts-playground.js"></script>
