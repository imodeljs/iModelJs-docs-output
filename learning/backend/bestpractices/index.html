<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Best Practices for Writing Backend Code and Designing RpcInterfaces - iModel.js</title>
    <meta name="og:title" content="Best Practices for Writing Backend Code and Designing RpcInterfaces - iModel.js">
    <meta name="twitter:title" content="Best Practices for Writing Backend Code and Designing RpcInterfaces - iModel.js">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" type="text/css" href="https://imodeljs.github.io/iModelJs-docs-output//styles/bundle.css">

    <!-- bootstrap -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>

    <!-- fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet"> 
    
    <link rel="stylesheet" type="text/css" href="https://imodeljs.github.io/iModelJs-docs-output//styles/devRegistration.css"> 
    
    <link rel="stylesheet" type="text/css" href="https://imodeljs.github.io/iModelJs-docs-output//styles/landingPage.css">  
        <link rel='shortcut icon' type='image/x-icon' href='https://imodeljs.github.io/iModelJs-docs-output//landing-page/assets/imodeljs_16.png' /> 
        <meta property="og:description" content="Create Immersive Connections with your Infrastructure Digital Twin."><meta property="og:url" content="imodeljs.org"><meta name="twitter:card" content="summary_large_image">
        <meta property="og:image" content="https://imodeljs.github.io/iModelJs-docs-output//landing-page/assets/twitter-share.png">
        <meta />
</head>

<body data-site-root=https://imodeljs.github.io/iModelJs-docs-output// class='layout-index '>
    <span id="contentLoader">
        <p>Woah! This page has a great deal of content... Give us a second to load it.</p>
    </span>
    <span id="contentLoaderBackground"></span>
    <div id="flex-wrapper">



        <header id="main-header">
            <div class='nav-header-container'>
                <nav class="navbar nav-main-header navbar-expand-md fixed-top navbar-light pb-0">
                    <a href="https://imodeljs.github.io/iModelJs-docs-output//" class="navbar-brand">
                            <img id="site-logo" class="site-logo" src="https://imodeljs.github.io/iModelJs-docs-output//landing-page/assets/imodeljs-logo.svg" /> 
                            <img id="site-logo-small" class="site-logo-small" src="https://imodeljs.github.io/iModelJs-docs-output//landing-page/assets/imodeljs-icon.svg" style="display:none;"/> 
                    </a>
                    <button class="navbar-toggler no-user-select mr-auto" type="button" data-toggle="collapse" data-target="#navbar5">
                        <span class="navbar-toggler-header"></span>
                    </button>
                    <ul class="navbar-nav ml-auto pr-0 nav-search">
                        <span class='search-bar'>
                          <li>
                            <div id='search-container'>
                            </div>
                          </li>
                          <script>
                            (function() {
                              var cx = '018053174497532353467:v_gnrjjlqwc';
                              var gcse = document.createElement('script');
                              gcse.type = 'text/javascript';
                              gcse.async = true;
                              gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
                              var s = document.getElementsByTagName('script')[0];
                              s.parentNode.insertBefore(gcse, s);
                            })();
                          </script>
                          <gcse:searchresults-only gname="sitesearch" resultSetSize="7"></gcse:search>
                        </span>
                    </ul>
                    <div class="navbar-collapse collapse justify-content-stretch" id="navbar5">
                        <ul class="navbar-nav mb-0" id="doc-site-tabs">
                                <li class="nav-item "><a class="nav-link" href="https://imodeljs.github.io/iModelJs-docs-output//getting-started">Getting Started</a></li><li class="nav-item "><a class="nav-link" href="https://imodeljs.github.io/iModelJs-docs-output//bis">BIS</a></li><li class="nav-item active"><a class="nav-link" href="https://imodeljs.github.io/iModelJs-docs-output//learning">Learning</a></li><li class="nav-item "><a class="nav-link" href="https://imodeljs.github.io/iModelJs-docs-output//reference">API Reference</a></li><li class="nav-item change-history-tab "><a class="nav-link" href="https://imodeljs.github.io/iModelJs-docs-output//changehistory">v1.8.0</a></li>
                        </ul>
                    </div>
                </nav>
            </div>
        </header>
<div id='main-wrapper'>
    <nav id='sidebar'>
        <div id='table-of-contents' class="custom-scrollbar">
            <div id="dismiss">
                <i id="dismiss-arrow" class="icon icon-chevron-left no-user-select"></i>
            </div>
            <hr id="dismiss-hr" class='sm-only'>
            <ul id='main-navigation-list'>
                <html><head></head><body><h3 id="the imodel.js library"><a href="https://imodeljs.github.io/iModelJs-docs-output//learning/" class="table-of-contents-link">The iModel.js Library</a></h3>
    <ul>
    <li><a href="https://imodeljs.github.io/iModelJs-docs-output//learning/frontend/" class="table-of-contents-link">Frontend</a></li>
    <li><a href="https://imodeljs.github.io/iModelJs-docs-output//learning/backend/" class="table-of-contents-link">Backend</a></li>
    <li><a href="https://imodeljs.github.io/iModelJs-docs-output//learning/common/" class="table-of-contents-link">Common</a></li>
    <li><a href="https://imodeljs.github.io/iModelJs-docs-output//learning/geometry/" class="table-of-contents-link">Geometry</a></li>
    <li><a href="https://imodeljs.github.io/iModelJs-docs-output//learning/presentation/" class="table-of-contents-link">Presentation</a></li>
    <li><a href="https://imodeljs.github.io/iModelJs-docs-output//learning/ui/" class="table-of-contents-link">UI</a></li>
    </ul>
    <hr>
    <p>&#xA0;</p>
    <h3 id="helpful links">Helpful links</h3>
    <ul>
    <li><a href="https://imodeljs.github.io/iModelJs-docs-output//./learning/ecsql" class="table-of-contents-link">ECSQL</a></li>
    <li><a href="https://imodeljs.github.io/iModelJs-docs-output//learning/imodelhub/" class="table-of-contents-link">iModelHub</a></li>
    <li><a href="https://imodeljs.github.io/iModelJs-docs-output//./learning/wireformat" class="table-of-contents-link">Wire Format</a></li>
    <li><a href="https://imodeljs.github.io/iModelJs-docs-output//./learning/faq" class="table-of-contents-link">Frequently Asked Questions</a></li>
    <li><a href="https://imodeljs.github.io/iModelJs-docs-output//learning/guidelines/" class="table-of-contents-link">Guidelines and Tips</a></li>
    <li><a href="https://imodeljs.github.io/iModelJs-docs-output//./learning/glossary" class="table-of-contents-link">Glossary</a></li>
    </ul>
    </body></html>
            </ul>
        </div>
    </nav>    <div class='documentation-main'>
        <article id="main" class="main-content">
            <button type="button" id="sidebarCollapse" class="no-user-select"> <i class="bread-crumb-label bread-crumb-expand-leftnav icon icon-chevron-right no-user-select" id="expand-leftnav"></i></button><div class='bread-crumb-label'><a href="https://imodeljs.github.io/iModelJs-docs-output//learning/">Learning</a> > <a href="https://imodeljs.github.io/iModelJs-docs-output//learning/backend/">backend</a> > BestPractices</div>
            <div class="edit-link"><a href="https://github.com/imodeljs/imodeljs/tree/master/docs/learning/backend/BestPractices.md">Edit this page</a></div>
            <h1 id="best practices for writing backend code and designing rpcinterfaces">Best Practices for Writing Backend Code and Designing RpcInterfaces</h1>
<p>When writing a backend, you are effectively writing a server. A server has several unique requirements. It has no UI of its own, and so logging must be used to diagnose problems and to monitor health. A server may have many clients, and so it must not spend too much time on any single request. A server may return its results over the Internet, and so bandwidth must be considered. Here are some tips for writing a backend that meets these requirements.</p>
<p>Many of these requirements affect the design of <a href='https://imodeljs.github.io/iModelJs-docs-output//./learning/rpcinterface'>RpcInterfaces</a>.</p>
<p>While the focus of this article is on backend and RpcInterface design, in many cases frontend/client design is the other side of the same coin. The <a href="#rpcinterfaces-and-frontend-design">last section</a>  describes some implications for frontends of backend design best practices where applicable.</p>
<h2 class="h-diagnostics">Diagnostics<a id="diagnostics" class="heading-anchor" href="#diagnostics"><span><i class="fa fa-link fa-rotate-90"></i></span></a></h2>
<p>Log all Errors that you throw. Be sure to define the logging-related arguments to the <a href='https://imodeljs.github.io/iModelJs-docs-output//./reference/imodeljs-common/imodels/imodelerror'>IModelError</a> constructor.</p>
<p>Maintain the ClientRequestContext so that logging emitted by backend and common code is correlated with frontend requests. See <a href='https://imodeljs.github.io/iModelJs-docs-output//./learning/backend/managingclientrequestcontext'>the learning article</a>.</p>
<p>The backend product should be configured to <a href='https://imodeljs.github.io/iModelJs-docs-output//./learning/backend/crashreporting'>report crashes and other fatal errors</a>.</p>
<h2 class="h-do-not-block-too-long">Do not Block Too Long<a id="do-not-block-too-long" class="heading-anchor" href="#do-not-block-too-long"><span><i class="fa fa-link fa-rotate-90"></i></span></a></h2>
<p>Use async functions when an operation is inherently asynchronous. Example: requesting a resource from the Internet or reading a huge image file from disk.</p>
<p>Break up a long-running synchronous operation into small increments, yielding back to the libuv event loop at regular intervals. You might say that your server must &quot;come up for air&quot; often to remain responsive. The operation becomes a series of asynchronous operations.</p>
<p>Here is some pseudo-code to illustrate yielding.</p>
<pre class="no-line-numbers"><code class="language-typescript">const pause = (ms: number) =&gt; new Promise((resolve) =&gt; setTimeout(resolve, ms));

async someServerFunction(many items): Promise&lt;boolean&gt; {
   while (processing many items) {
      if (time elapsed &gt; 100 ms)
        await pause(0);
   }
   return Promise.resolve(true);
}</code></pre>
<p>Note how the loop calls <code>setTimeout</code>. That is what causes the code to yield all the way to libuv event loop.</p>
<p>At the same time, the units of work performed by backend code must be &quot;right-sized&quot;, not too large or too small. This requirement is addressed mostly in RpcInterface and frontend design, <a href="#rpcinterfaces-and-frontend-design">as described below</a>.</p>
<h2 class="h-version-each-rcpinterface">Version each RcpInterface<a id="version-each-rcpinterface" class="heading-anchor" href="#version-each-rcpinterface"><span><i class="fa fa-link fa-rotate-90"></i></span></a></h2>
<p>Change the version of an RpcInterface if you change its shape, as explained <a href='https://imodeljs.github.io/iModelJs-docs-output//./learning/rpcinterface/#rpcinterface-versioning'>here</a>.</p>
<h2 class="h-operation-interleaving">Operation Interleaving<a id="operation-interleaving" class="heading-anchor" href="#operation-interleaving"><span><i class="fa fa-link fa-rotate-90"></i></span></a></h2>
<p>Backend code must be prepared for a series of asynchronous operations to be interleaved with other operations. For example, while running the processing loop above, the backend may receive and begin to process a new request. The backend must set mode flags or acquire locks as needed in order to prevent interleaved operations from interfering with each other.</p>
<p>Be prepared for redundant requests. After one client requests a long-running operation, another client (or the same client) might request the same operation, while the first is still in progress. Memoizing a Promise is a good way to handle redundant requests. That way, all redundant calls get back the same Promise, which is resolved once for all when the operation finishes.</p>
<h2 class="h-rpcinterfaces-and-frontend-design">RpcInterfaces and Frontend Design<a id="rpcinterfaces-and-frontend-design" class="heading-anchor" href="#rpcinterfaces-and-frontend-design"><span><i class="fa fa-link fa-rotate-90"></i></span></a></h2>
<h3 class="h-right-sized-requests">Right-sized requests<a id="right-sized-requests" class="heading-anchor" href="#right-sized-requests"><span><i class="fa fa-link fa-rotate-90"></i></span></a></h3>
<p>RpcInterfaces must be &quot;phrased&quot; so that clients can make right-sized requests. RpcInterfaces must be &quot;chunky&quot; and not &quot;chatty&quot;. One good strategy to avoid chatty interfaces is to <a href='https://imodeljs.github.io/iModelJs-docs-output//./learning/apptailoring/#backends-for-frontends'>write a backend that is tailored to the needs of the frontend</a>.</p>
<h3 class="h-paged-queries">Paged Queries<a id="paged-queries" class="heading-anchor" href="#paged-queries"><span><i class="fa fa-link fa-rotate-90"></i></span></a></h3>
<p>A client must not issue a query that produces a very large result. Instead, a client must break up a large query into a series of requests, so that results are returned in small increments. The ECSql limit/offset query parameters are used for this purpose.</p>
<h3 class="h-event-driven-design">Event-Driven Design<a id="event-driven-design" class="heading-anchor" href="#event-driven-design"><span><i class="fa fa-link fa-rotate-90"></i></span></a></h3>
<p>Frontend and backend never run in the same JavaScript context. Requests are always asynchronous, and it is impossible to predict how long even a right-sized request will take. Frontend code must be designed like a state machine and must be event-driven. For example, the frontend must go into a mode where only part of its UI is available while some long-running backend operation such as opening a briefcase or importing a schema is in progress. Query-paging is another example of the need for a frontend to maintain state data.</p>
<h3 class="h-refreshing">Refreshing<a id="refreshing" class="heading-anchor" href="#refreshing"><span><i class="fa fa-link fa-rotate-90"></i></span></a></h3>
<p>Web apps must be ready for remote backends to become temporarily or permanently unavailable. If, for example, an RcpInterface method fails with an unexpected error, such as ECONNRESET, the client operation should fail gracefully. The failure may be due to a temporary communications failure. If so, the operation may be re-tried.</p>
<!-- TODO: What if the orchestractor must re-start the backend? Does the client have to acquire a new IModelConnection? -->
<h3 class="h-check-for-rpcinterface-version-errors">Check for RpcInterface Version Errors<a id="check-for-rpcinterface-version-errors" class="heading-anchor" href="#check-for-rpcinterface-version-errors"><span><i class="fa fa-link fa-rotate-90"></i></span></a></h3>
<p>See <a href='https://imodeljs.github.io/iModelJs-docs-output//./learning/rpcinterface/#rpcinterface-versioning'>RpcInterface versioning</a>.</p>
<!-- TODO: Need more on when this can happen and what to do about it. -->

            <p class='last-updated'>Last Updated:
                <span class='date-updated'>22 November, 2019</span>
            </p>
            <div id="imodeljs-github-comments">
            </div>
            
            <script>
              $(document).ready(function () {
                function initializeComments(repo) {
                  var s = document.createElement('script');
                  s.src = "https://imodeljs.github.io/iModelJs-docs-output//scripts/utterances/client.js";
                  s.setAttribute('repo', repo);
                  s.setAttribute('issue-term', 'title');
                  s.setAttribute('crossorigin', 'anonymous');
                  s.setAttribute('theme', 'github-light');
                  s.async = true;
            
                  document.getElementById("imodeljs-github-comments").appendChild(s);
                }
            
                var shouldShow = ldclient.variation(featureFlags.GithubIssuesFeedback);
            
                // shouldShow is undefined when ldclient has not emitted 'ready'.
                if (shouldShow === undefined) {
                  ldclient.on('ready', function () {
                    var gitIssueFlag = ldclient.variation(featureFlags.GithubIssuesFeedback);
                    var gitRepo = ldclient.variation(featureFlags.GitRepo);
                    if (gitIssueFlag) {
                      initializeComments(gitRepo);
                    }
                  });
                }
                else if (shouldShow) {
                  var gitRepo = ldclient.variation(featureFlags.GitRepo);
                  initializeComments(gitRepo);
                }
              });
            </script>
            
            <script type="text/javascript">
            
            </script>        </article>
    </div>
    <div class="toc-overlay"></div>
    <div id='inner-table-of-contents'>
       <!-- <div id='sticky-container' style="top: 76px; position: fixed;">
  <h4 class='heading'>On this page</h4>
    <div id="overview-container" class="clusterize-scroll">
      <ul id='nav' class='right-nav nav flex-column clusterize-content'>
              <li class='nav-item item '>
            <a class='title solo-title menu-text' href="#diagnostics">Diagnostics</a>
    </li>
       <li class='nav-item item '>
            <a class='title solo-title menu-text' href="#do-not-block-too-long">Do not Block Too Long</a>
    </li>
       <li class='nav-item item '>
            <a class='title solo-title menu-text' href="#version-each-rcpinterface">Version each RcpInterface</a>
    </li>
       <li class='nav-item item '>
            <a class='title solo-title menu-text' href="#operation-interleaving">Operation Interleaving</a>
    </li>
       <li class='nav-item item '>
            <a data-target="#inner-nav-rpcinterfaces-and-frontend-design" class='title' href="#rpcinterfaces-and-frontend-design"/>
            <b class='dropdown-menu-title menu-text'>RpcInterfaces and Frontend Design</b>
            <i class='nav-list-dropdown icon'></i>
            </a>
            <ul id="inner-nav-rpcinterfaces-and-frontend-design" class='inner-nav'>
                    <li class='nav-item item '>
                            <a class='title solo-title menu-text' href="#right-sized-requests">Right-sized requests</a>
                    </li>
                    <li class='nav-item item '>
                            <a class='title solo-title menu-text' href="#paged-queries">Paged Queries</a>
                    </li>
                    <li class='nav-item item '>
                            <a class='title solo-title menu-text' href="#event-driven-design">Event-Driven Design</a>
                    </li>
                    <li class='nav-item item '>
                            <a class='title solo-title menu-text' href="#refreshing">Refreshing</a>
                    </li>
                    <li class='nav-item item '>
                            <a class='title solo-title menu-text' href="#check-for-rpcinterface-version-errors">Check for RpcInterface Version Errors</a>
                    </li>
            </ul>
    </li>
 
      </ul>
    </div>
  </div>

 -->
    </div>
</div>

<!-- Footer -->
<footer class="page-footer font-small mdb-color pt-1 pb-3">
  <!-- Footer Links Container -->
  <div class="container text-center text-md-left">

    <!-- Grid row -->
    <div class="row d-flex align-items-center mt-2">

      <!-- Grid column -->
      <div class="col-md-7 col-lg-8 align-top d-none d-md-block">

        <a href="https://imodeljs.github.io/iModelJs-docs-output//" class="navbar-brand">
          <img id="site-logo" class="site-logo" style="zoom:75%;"
            src="https://imodeljs.github.io/iModelJs-docs-output//landing-page/assets/imodeljs-logo.svg" />
        </a>
        <small style="color: white; margin-right: 7px;"> powered by </small>
        <a href="https://www.bentley.com">
          <img href="https://www.bentley.com" id="sponsored-by-logo" class="sponsored-by-logo"
            style="zoom:75%; width: 162px; height: 37px;"
            src="https://imodeljs.github.io/iModelJs-docs-output//landing-page/assets/bentley.svg" />
        </a>
      </div>
      <!-- Grid column -->

      <!-- TOS/Legals footer placeholder -->
      <div id="HFRootHeader"></div>

      <!-- Grid column -->
      <div class="col-md-5 col-lg-4 ml-lg-0">

        <!-- Social buttons -->
        <div class="text-center text-md-right">
          <ul class="list-unstyled list-inline">
            <li class="list-inline-item">
              <a class="btn-floating btn-sm rgba-white-slight mx-1" href="https://twitter.com/imodeljs" target="_blank">
                <i class="fa fa-twitter"></i>
              </a>
            </li>
            </li>
            <li class="list-inline-item">
              <a class="btn-floating btn-sm rgba-white-slight mx-1" href="https://github.com/imodeljs" target="_blank">
                <i class="fa fa-github"></i>
              </a>
            </li>
            <li class="list-inline-item">
              <a class="btn-floating btn-sm rgba-white-slight mx-1" href="https://stackoverflow.com/tags/imodeljs"
                target="_blank">
                <i class="fa fa-stack-overflow"></i>
              </a>
            </li>
          </ul>
        </div>

      </div>
      <!-- Grid column -->

    </div>
    <!-- Grid row -->

  </div>
  <!-- Footer Links Container -->

</footer>
<!-- Footer -->

</div>
<a href="javascript:" id="return-to-top"><i class="icon icon-chevron-up"></i></a>
<script src="https://imodeljs.github.io/iModelJs-docs-output//scripts/bundle.js"></script>
</body>

</html>
<script src="https://imodeljs.github.io/iModelJs-docs-output//scripts/monaco-editor/min/vs/loader.js"></script>
<script src="https://imodeljs.github.io/iModelJs-docs-output//scripts/ts-playground.js"></script>
